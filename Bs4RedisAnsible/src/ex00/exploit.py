from bs4 import BeautifulSoup
import webbrowser
import os

ORIGIN_FILE = "../../materials/evilcorp.html"
SAVE_FILE = "../../materials/evilcorp_hacked.html"

SCRIPT = """
 <script>
        hacked = function() {
            alert('hacked');
        }
        window.addEventListener('load',
          function() {
            var f = document.querySelector("form");
            f.setAttribute("onsubmit", "hacked()");
          },
          false
        );
</script>
"""

# First, it needs to read a file "evilcorp.html"


def get_soup():
    with open(ORIGIN_FILE) as file:
        content = file.read()
    soup = BeautifulSoup(content, 'html.parser')
    return soup


# Second, it should modify page title (in <title> tags) to be
# "Evil Corp - Stealing your money every day"
def change_title(soup):
    title = soup.find('title')
    title.string = "Evil Corp - Stealing your money every day"


# Third, it should parse out the name of the user from the page
# (including the pronoun) and inject new tag <h1>
# into a body of a page, saying <h1>Mr. Robot, you are hacked!</h1>,
# where 'Mr. Robot' is a parsed pronoun and name.
def append_to_body(soup):
    name = soup.find('span', class_='name').get_text()
    body = soup.find('body')
    new_tag = soup.new_tag("h1")
    new_tag.string = f"{name}, you are hacked!"
    body.append(new_tag)
    soup2 = BeautifulSoup(SCRIPT, 'html.parser')
    body.append(soup2.find('script'))


# Finally, the link at the bottom of a page should now
# lead to "https://mrrobot.fandom.com/wiki/Fsociety" with
# an actual name of the company on a page replaced with "Fsociety".
def change_link(soup):
    company_tag = soup.find('a')
    company_href = company_tag.get('href')
    company_name = company_href.split('/')[-1]
    company_href = company_href.replace(company_name, 'testgg')
    company_tag['href'] = company_tag['href'].replace(company_name, 'Fsociety')


# Save new Html file
def main():
    soup = get_soup()
    change_title(soup)
    append_to_body(soup)
    change_link(soup)
    with open(SAVE_FILE, 'w') as file:
        file.write(soup.prettify())
    webbrowser.open('file://' + os.path.abspath(SAVE_FILE))


if __name__ == "__main__":
    main()
